<apex:page>
    <head>
        <title>Org Check</title>
    </head>
    <apex:includeLightning />
    <style>
        .orgcheck-app {
            height: 100vh;
            background: linear-gradient(white, #878797 150px, #000000 70%);
        }
        .orgcheck-loading {
            text-align: center;
            animation: orgcheck-moveLogo 3s linear 1s forwards;
            background-color: #00000000;
            border: 0px;
            position: relative;
            z-index: 1;
            top: 25vh;
        }
        @keyframes orgcheck-moveLogo {
            0% {
                top: 25vh;
            }
            100% {
                top: 0vh;
            }
        }
        .orgcheck-loading-logo {
        }
        .orgcheck-loading-text {
            animation: orgcheck-intro 4s ease-out 0.5s forwards;
            color: rgb(75, 213, 238);
            font-weight: 400;
            font-size: 300%;
            opacity: 0;
        }
        @keyframes orgcheck-intro {
            0% {
                opacity: 0.25;
            }
            20% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                opacity: 0.5;
            }
        }        
        .orgcheck-jokes-board {
            font-family: Century Gothic, CenturyGothic, AppleGothic, sans-serif;
            transform: perspective(300px) rotateX(25deg);
            transform-origin: 50% 100%;
            text-align: justify;
            position: absolute;
            margin-left: -10em;
            overflow: hidden;
            font-size: 350%;
            height: 50em;
            width: 20em;
            bottom: 0;
            left: 50%;
        }
        .orgcheck-jokes-board::after {    
            position: absolute;
            content: ' ';
            bottom: 60%;
            left: 0;
            right: 0;
            top: 0;
        }
        .orgcheck-jokes-content {
            animation: orgcheck-scrollJokes 100s linear 4s;
            position: absolute;
            top: 100%;
        }
        .orgcheck-jokes-content > p {
            font-size: 30px;
            font-weight: bolder;
            color: #FFFF82;
            margin-bottom: 5em;
        }
        @keyframes orgcheck-scrollJokes {
            0% {
                top: 100%;
            }
            100% {
                top: 0%;
            }
        }
        .slds-dropdown-trigger_click .slds-dropdown {
            min-width: fit-content;
        }
    </style>
    <div class="orgcheck-app" id="orgcheck-app">
        <div id="orgcheck-loading-box">
            <section class="orgcheck-loading" id="orgcheck-loading">
                <div class="orgcheck-loading-logo">
                    <object type="image/svg+xml" data="{!URLFOR($Resource.OrgCheck_SR, 'img/Mascot+Animated.svg')}" width="200" height="200">
                        <img src="{!URLFOR($Resource.OrgCheck_SR, 'img/Mascot+Animated.svg')}" width="200" height="200" />
                    </object>
                    <object type="image/svg+xml" data="{!URLFOR($Resource.OrgCheck_SR, 'img/Logo.svg')}" width="250" height="250">
                        <img src="{!URLFOR($Resource.OrgCheck_SR, 'img/Logo.svg')}" width="250" height="250" />
                    </object>
                </div>
                <div class="orgcheck-loading-text" id="orgcheck-loading-text" />
            </section>
            <section class="orgcheck-jokes-board" >
                <div class="orgcheck-jokes-content" id="orgcheck-jokes">
                </div>
            </section>
        </div>
    </div>  
    <script>
        const jokes = [
            { question: `Chances are if you've seen one shopping center...`, answer: `You've seen a mall`},
            { question: `Did you hear about the artist that was baroque?`, answer: `He stole the Monet, to buy Degas, to make the Van Gogh.` },
            { question: `Did you know Stephen King has a son named Joe?`, answer: `I am not joking, but he is.` },
            { question: `Doctor: How is that kid who swallowed those coins doing?`, answer: `Nurse: No change yet.`},
            { question: `Don't mess up with French people üá´‚Äçüá∑`, answer: `We eat pain for breakfast` },
            { question: `How can you tell a vampire has a cold?`, answer: `They start coffin.` },
            { question: `How did Darth Vader know what Luke was getting for his birthday?`, answer: `He felt his presents!` },
            { question: `How do you organize a space party?`, answer: `You planet.`},
            { question: `How do you turn deviled eggs into regular eggs?`, answer: `It takes an eggsorcism.` },
            { question: `I just crashed my new kia`, answer: `Now I have Nokia` },
            { question: `I just downloaded the Titanic soundtrack...`, answer: `It's syncing right now.` },
            { question: `I tried to climb a really tall tower in France...`, answer: `but Eiffel off` },
            { question: `I was going to get a brain transplant...`, answer: `but I changed my mind` },
            { question: `I went to a prison poetry reading...`, answer: `It had it's prose and cons` },
            { question: `I'm writing a book about reverse psychology.`, answer: `Please don't buy it...` },
            { question: `If you have way too many dad-jokes, where can you store them all?`, answer: `In a dadda-lake` },
            { question: `If you lose your khakis in Texas, you can't find your pants...`, answer: `If you lose your khakis in Boston, you can't start your car!` },
            { question: `My son told me that Jim Morrison was overrated so I sent him to his room...`, answer: `Nobody slams The Doors in my house!` },
            { question: `My wife asked me to stop singing I'm a Believer by the Monkees because she found it annoying.`, answer: `At first, I thought she was kidding. But then I saw her face...` },
            { question: `My wife asked me to stop singing Oasis.`, answer: `So, I said maybe...` },
            { question: `My wife bought me a new reversible jacket...`, answer: `I can't wait to see how it turns out` },
            { question: `People always talk about the "Eye of the Tiger".`, answer: `Yeah. No one talks about the other four letters...` },
            { question: `People say Excel is terrible, but I use it every day and think it is pretty good.`, answer: `I'd rate it October 10th.` },
            { question: `Puns make me numb`, answer: `Math puns make me number` },
            { question: `The fight between Superman and Dracula has been postponed.`, answer: `Superman can't go near the crypt tonight.` },
            { question: `There are a quantity of artificial butter flavor beyond which people begin to believe it's not butter.`, answer: `This is known as the margarine of error.` },
            { question: `Today I'm wearing pink to raise awareness for people like me...`, answer: `who forget to separate their red laundry from their whites.` },
            { question: `Two cats are having a swimming race. The American one is named "One Two Three". The French one is "Un Deux Trois." Which cat wins?`, answer: `The American because "Un Deux Trois" cat sank.` },
            { question: `What did the scarf say to the hat?`, answer: `You go on ahead, I am going to hang around a bit longer.` },
            { question: `What do you call a fashionable lawn statue with an excellent sense of rhythmn?`, answer: `A metro-gnome`},
            { question: `What do you call a fish wearing a bowtie?`, answer: `Sofishticated` },
            { question: `What do you call a French man wearing sandals?`, answer: `Philippe Philoppe` },
            { question: `What do you call a magician who loses his magic?`, answer: `Ian` },
            { question: `What do you call a pig with three eyes?`, answer: `Piiig` },
            { question: `What does the Hulk wear to bed?`, answer: `Py-gammas.` },
            { question: `What kind of fish is made up of only two sodium atoms?`, answer: `2 Na` },
            { question: `What's a runner's favorite subject in school?`, answer: `Jog-graphy.` },
            { question: `Where can you save your dad-jokes?`, answer: `In a dadda-base` },
            { question: `Why are ghosts bad liars?`, answer: `Because you can see right through them!` },
            { question: `Why did the coffee file a police report?`, answer: `It got mugged.` },
            { question: `Why did the French chef give up?`, answer: `He lost the huile d'olive` },
            { question: `Why did the math book look sad?`, answer: `Because it had too many problems.` },
            { question: `Why did the tomato turn red?`, answer: `Because it saw the salad dressing.` },
            { question: `Why do cows not have toes?`, answer: `They lactose!` },
            { question: `Why do French people eat only one egg for dinner?`, answer: `Because one egg is un oeuf.` },
            { question: `Why do the French eat snails?`, answer: `They don't like fast food` },
        ];
        const div_jokes = document.getElementById('orgcheck-jokes');
        const NB_JOKES = 7;
        for (let i = 0; i < NB_JOKES; i++) {
            const index = Math.floor(Math.random() * jokes.length);
            const joke = jokes.splice(index, 1)[0];
            const paragraph = document.createElement('p');
            paragraph.innerHTML = `${joke.question} &nbsp; ${joke.answer}`;
            div_jokes.appendChild(paragraph);
        }

        /* Reset the cache of previous versions of Org Check that used VFP localStorage (before LWC impl.) */
        try {
            Object.keys(localStorage)
                .filter(e => e.startsWith('OrgCheck.'))
                .forEach(e => localStorage.removeItem(e));
        } catch (e) {
            console.error('For your information, I had an error while resetting the cache of previous Org Check versions (prior to Lithium).')
        }

        /* Determine the namespace where the app is running (if local/standalone the package is 'c') */ 
        const firstSubDomain = document.location.host.split('.')[0];
        const subDomainParts = firstSubDomain.split('--');
        const namespace = subDomainParts.pop(); // last part is the package name
        
        /* Insert LWC app */
        const app = `${namespace}:OrgCheck_App_Aura`;
        const component = `${namespace}:orgcheckApp`;
        
        /* Load the app */
        function loadOrgCheckApp() {
            $Lightning.use(app, () => {
                $Lightning.createComponent(
                    component, 
                    { 
                        accessToken: '{! JSENCODE($Api.Session_Id) }', 
                        userId: '{! JSENCODE($User.Id) }',
                        textEncoder: new TextEncoder(),
                        textDecoder: new TextDecoder(),
                        localStorage: window.localStorage
                    },
                    'orgcheck-app',
                    () => {
                        document.getElementById('orgcheck-loading-box').remove();
                    }
                );
            });
        }

        /* Launch the app for real */
        const loadingText = document.getElementById('orgcheck-loading-text');
        let creditsModeOn = false;
        loadingText.addEventListener('click', (event) => { creditsModeOn = true; }, true);
        loadingText.innerHTML = 'Please wait while <b>Org Check</b> is l<img src="/img/loading.gif" alt="o" />ading...';
        setTimeout(() => { 
            if (creditsModeOn === false) { 
                loadOrgCheckApp(); 
            } else {
                loadingText.innerHTML = `Credits mode activated! <br /> Enjoy these ${NB_JOKES} <b>dad jokes</b> before we load <b>Org Check</b>!`; 
                div_jokes.addEventListener('animationend', () => { 
                    div_jokes.style.visibility = 'hidden';
                    loadingText.innerHTML = 'Now we load the app (finally!)'; 
                    loadOrgCheckApp(); 
                }, true);
            } 
        }, 2000);
    </script>
</apex:page>